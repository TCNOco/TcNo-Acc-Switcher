@*TcNo Account Switcher - A Super fast account switcher
    Copyright (C) 2019-2022 TechNobo (Wesley Pyburn)
    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.
    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses />.*@

@using TcNo_Acc_Switcher_Server.Shared.Modal
@using TcNo_Acc_Switcher_Server.Data
@using TcNo_Acc_Switcher_Globals
@using TcNo_Acc_Switcher_Server.Pages.General
@using TcNo_Acc_Switcher_Server.Shared.Modal.Components
@using Newtonsoft.Json
@using System.IO
@using TcNo_Acc_Switcher_Server.State
@using TcNo_Acc_Switcher_Server.State.DataTypes
@inject Modals Modals
@inject IJSRuntime JsRuntime


@code {
    protected override void OnInitialized()
    {
        Modals.PathPickerOnChange += OnChangeHandler;
        OnChangeHandler(); // Run once just to set vars
    }

    private async void OnChangeHandler()
    {
        Modals.Title = Modals.PathPicker.ModalHeader;

        _found = false;
        var pp = Modals.PathPicker;
        var r = pp.RequestedFile;

        // Show/Hide indicator
        if (r != "AnyFile" && r != "AnyFolder") _showIndicator = true;

        if (r == "AnyFile" && pp.LastElement == PathPickerElement.File) // Any file requested and one was clicked.
            _found = true;
        else if (r == "AnyFolder" && pp.LastElement == PathPickerElement.Folder) // Any folder requested and one was clicked.
            _found = true;
        else if (pp.LastPath.EndsWith(r)) // Specific file or folder requested and one was clicked.
            _found = true;
        else if (Modals.PathPicker.Goal == PathPickerGoal.FindPlatformExe
                 && !string.IsNullOrEmpty(Modals.PathPicker.LastPath)
                 && !Globals.IsFile(Modals.PathPicker.LastPath) // The path doesn't end with <app.exe>, so check to see if the folder contains it. This is accepted for FindPlatformExe.
                 && Directory.Exists(Modals.PathPicker.LastPath)
                 && Directory.GetFiles(Modals.PathPicker.LastPath).ToList().Contains(Modals.PathPicker.RequestedFile))
            _found = true;
        await InvokeAsync(StateHasChanged);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await JsRuntime.InvokeVoidAsync("focusOn", "#path");
    }

    private bool _showIndicator = false;
    private bool _found;
}

<div>
    <p class="modal-text">@Modals.PathPicker.ModalText</p>
</div>
<div class="inputAndButton">
    <input type="text" id="path" autocomplete="off" style="width: 100%;padding: 8px;" @onkeyup="KeyPress" value="@Modals.PathPicker.LastPath" @oninput="OnInput">
</div>
<div class="settingsCol inputAndButton">
    @if (_showIndicator)
    {
        <div class="folder_indicator @(_found ? "found" : "notfound")">
            <div id="folder_indicator_text"></div>
        </div>
        <div class="folder_indicator_bg @(_found ? "found" : "notfound")"><span>@Modals.PathPicker.RequestedFile</span></div>
    }
    <button class="modalOK" type="button" id="set_background" @onclick="Confirm"><span>@Modals.PathPicker.ModalButtonText</span></button>
</div>
<PathPicker />

@code
{
    private async Task OnInput(ChangeEventArgs args)
    {
        Modals.PathPicker.LastPath = args.Value?.ToString();
        Update();
        await JsRuntime.InvokeVoidAsync("pathPickerScrollToElement");
    }

    // Pressed Enter on the input
    private async Task KeyPress(KeyboardEventArgs k)
    {
        // If enter was pressed
        if (k.Key == "Enter")
        {
             await Confirm();
        }
    }

    // Update dynamically as the user types.
    private void Update() => Modals.PathPickerNotifyDataChanged();


    private async Task Confirm()
    {
        Modals.IsShown = false;

        if (Modals.PathPicker.Goal == PathPickerGoal.FindPlatformExe)
            Modals.UpdatePlatformFolder();
        else if (Modals.PathPicker.Goal == PathPickerGoal.SetBackground)
            Modals.SetBackground();
        else if (Modals.PathPicker.Goal == PathPickerGoal.SetUserdata)
            await Modals.ChangeUserdataFolder();
        else if (Modals.PathPicker.Goal == PathPickerGoal.SetAccountImage)
            await Modals.ChangeAccImage();


    }
}
