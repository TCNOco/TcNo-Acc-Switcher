@*TcNo Account Switcher - A Super fast account switcher
    Copyright (C) 2019-2022 TechNobo (Wesley Pyburn)
    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.
    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses />.*@

@inject NavigationManager NavigationManager
@using TcNo_Acc_Switcher_Globals
@using Microsoft.AspNetCore.WebUtilities
@using TcNo_Acc_Switcher_Server.State.DataTypes
@using TcNo_Acc_Switcher_Server.State
@using TcNo_Acc_Switcher_Server.State.Interfaces
@implements IDisposable
@inject IJSRuntime JsRuntime
@inject IToasts Toasts
@inject IStatistics Statistics

<Router AppAssembly="@typeof(Program).Assembly">
    <Found Context="routeData">
        <RouteView RouteData="@routeData" DefaultLayout="@typeof(MainLayout)"/>
    </Found>
    <NotFound>
        <LayoutView Layout="@typeof(MainLayout)">
            <p>Sorry, there's nothing at this address.</p>
        </LayoutView>
    </NotFound>
</Router>

@code
{
    private EventHandler<LocationChangedEventArgs> _locationChanged;
    protected override void OnInitialized()
    {
        _locationChanged = async (s, e) => await LocationChanged(s, e);
        // Subscribe to the event
        NavigationManager.LocationChanged += _locationChanged;
        base.OnInitialized();
    }

    void IDisposable.Dispose()
    {
        NavigationManager.LocationChanged -= _locationChanged;
    }

    private async Task LocationChanged(object sender, LocationChangedEventArgs e)
    {
        var navigationMethod = e.IsNavigationIntercepted ? "HTML" : "code";
        Console.WriteLine($@"Notified of navigation via {navigationMethod} to {e.Location}");
        await HandleQueries();

        Statistics.NewNavigation(e.Location);
    }

    /// <summary>
    /// For handling queries in URI
    /// </summary>
    public async Task<bool> HandleQueries()
    {
        Globals.DebugWriteLine(@"[JSInvoke:General\GeneralFuncs.HandleQueries]");
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        // Clear cache reload
        var queries = QueryHelpers.ParseQuery(uri.Query);
        // cacheReload handled in JS

        // Toast
        if (!queries.TryGetValue("toast_type", out var toastType) ||
            !queries.TryGetValue("toast_title", out var toastTitle) ||
            !queries.TryGetValue("toast_message", out var toastMessage)) return true;
        for (var i = 0; i < toastType.Count; i++)
        {
            try
            {
                var type = (ToastType)Enum.Parse(typeof(ToastType), toastType[i], true);
                await Toasts.ShowToastLangAsync(type, toastTitle[i], toastMessage[i]);
                await JsRuntime.InvokeVoidAsync("removeUrlArgs", "toast_type,toast_title,toast_message");
            }
            catch (TaskCanceledException e)
            {
                Globals.WriteToLog(e.ToString());
            }
        }

        return true;
    }
}
